# ultrahdr Crate Audit

*Created: 2026-01-25*

## Overview

Two crates in workspace:
- **`ultrahdr-core`** (3,800 lines) - Pure gain map math, metadata, no codec dependency, no_std compatible
- **`ultrahdr`** (2,600 lines) - JPEG container handling, re-exports core

**Total: ~16,000 lines** including tests and benchmarks.

---

## Current Module Structure

### ultrahdr-core

| Module | Lines | Purpose | Status |
|--------|-------|---------|--------|
| `types.rs` | 592 | `RawImage`, `GainMap`, `GainMapMetadata`, `Error`, enums | ✅ Core, keep |
| `color/tonemap.rs` | 1,359 | `AdaptiveTonemapper`, reinhard, filmic, bt2390, image-level tonemap | ⚠️ Overlap with zenimage |
| `color/streaming_tonemap.rs` | 1,040 | `StreamingTonemapper` with local adaptation | ⚠️ Move to zenimage |
| `color/gamut.rs` | 384 | Gamut conversion matrices, soft clip, luminance | ✅ Core |
| `color/convert.rs` | 385 | YUV↔RGB, format conversions | ✅ Core |
| `color/transfer.rs` | 453 | PQ/HLG/sRGB EOTF/OETF | ⚠️ Duplicates moxcms |
| `gainmap/compute.rs` | 472 | `compute_gainmap()` | ✅ Core |
| `gainmap/apply.rs` | 450 | `apply_gainmap()` | ✅ Core |
| `gainmap/streaming.rs` | 1,972 | `RowDecoder`, `StreamDecoder`, `RowEncoder`, `StreamEncoder` | ✅ Core |
| `metadata/xmp.rs` | 279 | XMP parsing/generation (hdrgm namespace) | ✅ Core |
| `metadata/iso21496.rs` | 261 | ISO 21496-1 parsing/generation | ✅ Core |
| `metadata/mpf.rs` | 457 | MPF directory parsing/generation | ⚠️ Move to ultrahdr |

### ultrahdr

| Module | Lines | Purpose | Status |
|--------|-------|---------|--------|
| `container.rs` | 806 | JPEG segment scanning, MPF assembly | ✅ Keep |
| `encode.rs` | 471 | `Encoder` builder, `encode_ultrahdr()` | ✅ Keep |
| `decode.rs` | 348 | `Decoder` | ✅ Keep |
| `jpeg/markers.rs` | 296 | JPEG marker constants, segment types | ✅ Keep |
| `jpeg/icc.rs` | 402 | ICC profile embedding/extraction | ⚠️ Duplicates zenjpeg |

---

## Feature Inventory

### What ultrahdr-core Provides

1. **Gain Map Math**
   - `compute_gainmap(hdr, sdr, config)` → `(GainMap, GainMapMetadata)`
   - `apply_gainmap(sdr, gainmap, metadata, boost)` → HDR
   - Streaming variants: `RowEncoder`, `StreamEncoder`, `RowDecoder`, `StreamDecoder`

2. **Metadata**
   - XMP parsing/generation (Adobe hdrgm namespace)
   - ISO 21496-1 binary format parsing/generation
   - MPF directory parsing/generation

3. **Color**
   - Transfer functions: PQ, HLG, sRGB EOTF/OETF
   - Gamut conversion matrices (BT.709, P3, BT.2020)
   - YUV↔RGB conversion
   - Soft gamut clipping

4. **Tonemapping**
   - Simple curves: Reinhard, Filmic, BT.2390
   - `AdaptiveTonemapper` - learns from HDR/SDR pairs
   - `StreamingTonemapper` - row-by-row with local adaptation

### What ultrahdr Provides

1. **Container Assembly**
   - `encode_ultrahdr(sdr_jpeg, gainmap_jpeg, metadata, gamut)` → Ultra HDR JPEG
   - MPF header generation with correct offsets
   - XMP embedding

2. **Decoder**
   - Parse Ultra HDR JPEG
   - Extract primary JPEG, gain map JPEG, metadata
   - `is_ultrahdr()` detection

3. **JPEG Utilities**
   - Segment scanning
   - ICC profile extraction/embedding
   - Marker parsing

---

## Identified Limitations

### 1. No CMS Integration
- Transfer functions hardcoded, no ICC profile support
- Gamut conversion uses fixed matrices, not full CMS
- Can't handle arbitrary input ICC profiles
- **Impact**: Can't correctly process images with embedded profiles

### 2. Tonemapper Limitations
- `AdaptiveTonemapper` requires full image for fitting
- `StreamingTonemapper` has fixed algorithm (no AgX, no filmic option)
- No CMS awareness (doesn't convert gamuts before/after tonemap)
- Local adaptation is good but inflexible
- **Impact**: Limited tonemapping options, can't match specific looks

### 3. JPEG-Only Container
- MPF is JPEG-specific
- Can't output AVIF/JXL/HEIF gain maps
- Container assembly tightly coupled to JPEG structure
- **Impact**: Can't support modern formats without major changes

### 4. Duplication with Ecosystem
- `color/transfer.rs` duplicates moxcms EOTF/OETF functions
- `jpeg/icc.rs` duplicates zenjpeg ICC handling
- Tonemapping duplicates/conflicts with zenimage design
- **Impact**: Maintenance burden, potential inconsistencies

### 5. RawImage Limitations
- `data: Vec<u8>` forces owned allocation
- No borrowed slice variant for zero-copy
- Stride handling is awkward for planar formats
- **Impact**: Unnecessary copies in streaming pipelines

### 6. Missing Features
- No CICP output (needed for AVIF/JXL)
- No 10-bit/16-bit gain map support
- No RGB gain maps (only grayscale or per-channel)
- No gain map quality presets
- **Impact**: Limited compatibility with modern workflows

---

## Proposed Slimming

### Remove from ultrahdr-core (Move to zenimage)

| Module | Lines | Reason |
|--------|-------|--------|
| `color/tonemap.rs` | 1,359 | Replaced by zenimage streaming tonemapper design |
| `color/streaming_tonemap.rs` | 1,040 | Replaced by zenimage streaming tonemapper design |
| `color/transfer.rs` | 453 | Use moxcms instead |

**Total removed: ~2,850 lines (75% of color module)**

### Keep in ultrahdr-core (Essential)

| Module | Lines | Reason |
|--------|-------|--------|
| `types.rs` | 592 | Core types, can't remove |
| `gainmap/compute.rs` | 472 | Core gain map math |
| `gainmap/apply.rs` | 450 | Core gain map math |
| `gainmap/streaming.rs` | 1,972 | Streaming gain map (essential for memory efficiency) |
| `metadata/xmp.rs` | 279 | XMP is required for Ultra HDR |
| `metadata/iso21496.rs` | 261 | ISO metadata for cross-platform |
| `color/gamut.rs` | 384 | Gamut matrices (used by gain map) |
| `color/convert.rs` | 385 | YUV conversion (used by gain map) |

**Total kept: ~4,800 lines**

### Refactor in ultrahdr-core

1. **Add `GainMapResult` with CICP codes**
   ```rust
   pub struct GainMapResult {
       pub gainmap: GainMap,
       pub metadata: GainMapMetadata,
       pub sdr_cicp: CicpCodes,  // For AVIF/JXL
       pub hdr_cicp: CicpCodes,
   }
   ```

2. **Support borrowed slices in RawImage**
   ```rust
   pub struct RawImageRef<'a> {
       pub width: u32,
       pub height: u32,
       pub format: PixelFormat,
       pub data: &'a [u8],
       // ...
   }
   ```

3. **Move MPF to ultrahdr crate** (it's JPEG-specific)

### Remove from ultrahdr

| Module | Lines | Reason |
|--------|-------|--------|
| `jpeg/icc.rs` | 402 | Use zenjpeg ICC handling instead |

### Keep in ultrahdr

| Module | Lines | Reason |
|--------|-------|--------|
| `container.rs` | 806 | JPEG-specific, this is ultrahdr's job |
| `encode.rs` | 471 | Essential |
| `decode.rs` | 348 | Essential |
| `jpeg/markers.rs` | 296 | JPEG-specific, needed |

---

## Slimmed Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         SLIMMED ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                       zenimage                                   │    │
│  │  • Streaming tonemapper (AgX, filmic, local adaptive)           │    │
│  │  • CMS integration (moxcms)                                      │    │
│  │  • Format negotiation                                            │    │
│  │  • ICC/CICP output                                               │    │
│  └───────────────────────────────┬─────────────────────────────────┘    │
│                                  │                                       │
│                                  │ uses                                  │
│                                  ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    ultrahdr-core (~3,500 lines)                  │    │
│  │                                                                  │    │
│  │  • GainMap, GainMapMetadata, RawImage types                     │    │
│  │  • compute_gainmap(), apply_gainmap()                           │    │
│  │  • RowEncoder, StreamEncoder, RowDecoder, StreamDecoder         │    │
│  │  • XMP parsing/generation                                        │    │
│  │  • ISO 21496-1 parsing/generation                               │    │
│  │  • Gamut matrices, YUV conversion                               │    │
│  │                                                                  │    │
│  │  NO: tonemapping, transfer functions, ICC handling              │    │
│  └───────────────────────────────┬─────────────────────────────────┘    │
│                                  │                                       │
│                                  │ uses                                  │
│                                  ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     ultrahdr (~1,900 lines)                      │    │
│  │                                                                  │    │
│  │  • JPEG container assembly (MPF)                                │    │
│  │  • encode_ultrahdr(), Encoder                                   │    │
│  │  • Decoder                                                       │    │
│  │  • JPEG segment scanning                                         │    │
│  │                                                                  │    │
│  │  NO: ICC handling (use zenjpeg), tonemapping                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  External dependencies:                                                  │
│  • moxcms - CMS (transfer functions, gamut conversion, ICC)             │
│  • zenjpeg - JPEG codec (encode/decode, ICC embedding)                  │
│  • enough - Cooperative cancellation                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Migration Path

### Phase 1: Feature-flag tonemapping
```toml
[features]
default = ["tonemap"]
tonemap = []  # Keep for backward compat, deprecate
```

### Phase 2: Remove transfer function duplication
- Remove `color/transfer.rs`
- Document: "Use moxcms for EOTF/OETF"
- Add moxcms as optional dependency for examples

### Phase 3: Move tonemapping to zenimage
- Copy tonemapper code to zenimage
- Enhance with CMS integration
- Remove from ultrahdr-core
- Major version bump (0.2.0)

### Phase 4: Add CICP support
- Add `CicpCodes` to gain map result
- Support AVIF/JXL metadata output
- Keep container assembly JPEG-only (other formats use different containers)

---

## Line Count Summary

| State | ultrahdr-core | ultrahdr | Total |
|-------|---------------|----------|-------|
| Current | ~5,100 | ~2,300 | ~7,400 |
| After slimming | ~3,500 | ~1,900 | ~5,400 |
| **Reduction** | **31%** | **17%** | **27%** |

Plus removal of duplication with moxcms/zenjpeg improves consistency.

---

## Open Questions

1. **Should ultrahdr-core depend on moxcms?**
   - Pro: Consistent transfer functions
   - Con: Adds dependency to no_std core
   - Recommendation: Optional dependency, document moxcms as preferred

2. **Should streaming gainmap encoder accept linear f32 directly?**
   - Currently expects specific `RawImage` formats
   - Streaming tonemapper outputs linear f32
   - Would simplify integration

3. **Should we support 16-bit gain maps?**
   - HEIF/AVIF can store higher precision
   - Current: 8-bit only
   - Recommendation: Add as optional feature

4. **Should MPF move from core to ultrahdr?**
   - MPF is JPEG-specific
   - Currently in ultrahdr-core/metadata/mpf.rs
   - Recommendation: Move to ultrahdr crate
